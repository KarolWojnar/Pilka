<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8">
    <title>Admin - Coaches</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class'
        }
    </script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        .highlighted {
            background-color: #2d3748;
        }
    </style>
</head>
<body class="bg-gray-900 text-white font-sans">
<div th:insert="~{fragments :: nav}"></div>
<div class="flex m-2">
    <div class="container mx-auto mt-10 px-5 py-3 bg-gray-700 rounded shadow-lg max-w-5xl w-2/3">
        <h1 class="text-2xl font-bold text-center mb-5">Coaches Management</h1>

        <table class="w-full text-left">
            <thead>
            <tr class="bg-gray-800">
                <th class="p-3">ID</th>
                <th class="p-3">Login</th>
                <th class="p-3">Name</th>
                <th class="p-3">Email</th>
                <th class="p-3">Actions</th>
            </tr>
            </thead>
            <tbody id="coachesTable">
            <tr th:each="coach : ${coaches}" class="border-b border-gray-600">
                <td class="p-3" th:text="${coach.id}"></td>
                <td class="p-3" th:text="${coach.login}"></td>
                <td class="p-3" th:text="${coach.firstName + ' ' + coach.lastName}"></td>
                <td class="p-3" th:text="${coach.email}"></td>
                <td class="p-3">
                    <button class="edit-btn bg-blue-500 hover:bg-blue-600 text-white py-1 px-2 rounded" th:data-id="${coach.id}">Edit</button>
                    <button class="delete-btn bg-red-500 hover:bg-red-600 text-white py-1 px-2 rounded" th:data-id="${coach.id}">Delete</button>
                </td>
            </tr>
            </tbody>
        </table>
    </div>

    <div id="editCoachForm" class="hidden mt-10 px-5 py-3 bg-gray-700 rounded shadow-lg max-w-md mx-auto w-1/3">
        <h2 class="text-xl font-bold mb-5">Edit Coach</h2>
        <form id="updateCoachForm" method="post">
            <input type="hidden" id="editCoachId" name="coachId">
            <div class="mb-4">
                <label for="editFirstName" class="block mb-2">First Name:</label>
                <input type="text" id="editFirstName" name="firstName" class="w-full p-2 rounded bg-gray-800 text-white" required>
            </div>
            <div class="mb-4">
                <label for="editLastName" class="block mb-2">Last Name:</label>
                <input type="text" id="editLastName" name="lastName" class="w-full p-2 rounded bg-gray-800 text-white" required>
            </div>
            <div class="mb-4">
                <label for="editEmail" class="block mb-2">Email:</label>
                <input type="email" id="editEmail" name="email" class="w-full p-2 rounded bg-gray-800 text-white" required>
            </div>
            <div class="mb-4">
                <label for="editLogin" class="block mb-2">Login:</label>
                <input type="text" id="editLogin" name="login" class="w-full p-2 rounded bg-gray-800 text-white" required>
            </div>
            <div class="mb-4">
                <label for="editTeam" class="block mb-2">Team:</label>
                <select id="editTeam" name="team" class="w-full p-2 rounded bg-gray-800 text-white" required>
                    <option th:each="team : ${teams}" th:value="${team.id}" th:text="${team.teamName}"></option>
                </select>
            </div>
            <div class="mb-4">
                <label for="editRole" class="block mb-2">Role:</label>
                <select id="editRole" name="role" class="w-full p-2 rounded bg-gray-800 text-white" required>
                    <option th:each="role : ${roles}" th:value="${role.id}" th:text="${role.name}"></option>
                </select>
            </div>
            <div class="mt-6 flex space-x-4">
                <button type="submit" class="bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded">Update</button>
                <button type="button" id="cancelEditBtn" class="bg-gray-500 hover:bg-gray-600 text-white py-2 px-4 rounded">Cancel</button>
            </div>
        </form>
    </div>
</div>

<script>
    let selectedRow = null;

    $(document).ready(function() {
        $('.edit-btn').click(function() {
            var coachId = $(this).data('id');

            if (selectedRow) {
                selectedRow.removeClass('highlighted');
            }

            selectedRow = $(this).closest('tr');
            selectedRow.addClass('highlighted');

            var coachData = {
                firstName: $(this).closest('tr').find('td').eq(2).text().split(' ')[0],
                lastName: $(this).closest('tr').find('td').eq(2).text().split(' ')[1],
                email: $(this).closest('tr').find('td').eq(3).text(),
                login: $(this).closest('tr').find('td').eq(1).text(),
                teamId: $(this).closest('tr').find('td').eq(4).text(),
                roleId: $(this).closest('tr').find('td').eq(5).text()
            };

            $('#editCoachId').val(coachId);
            $('#editFirstName').val(coachData.firstName);
            $('#editLastName').val(coachData.lastName);
            $('#editEmail').val(coachData.email);
            $('#editLogin').val(coachData.login);
            $('#editTeam').val(coachData.teamId);
            $('#editRole').val(coachData.roleId);

            $('#editCoachForm').removeClass('hidden');
        });

        $('#cancelEditBtn').click(function() {
            $('#editCoachForm').addClass('hidden');

            if (selectedRow) {
                selectedRow.removeClass('highlighted');
                selectedRow = null;
            }
        });

        $('.delete-btn').click(function() {
            var coachId = $(this).data('id');

            if (selectedRow) {
                selectedRow.removeClass('highlighted');
            }

            selectedRow = $(this).closest('tr');
            selectedRow.addClass('highlighted');

            $.ajax({
                type: 'get',
                url: '/admin/deleteCoach',
                data: { id: coachId },
                success: function(response) {
                    if (response.success) {
                        selectedRow.remove();
                        selectedRow = null;
                    } else {
                        console.log(response.statusText)
                        alert('Failed to delete coach');
                    }
                }
            });
        });

        $('#updateCoachForm').submit(function(event) {
            event.preventDefault();

            var formData = {
                id: $('#editCoachId').val(),
                firstName: $('#editFirstName').val(),
                lastName: $('#editLastName').val(),
                email: $('#editEmail').val(),
                login: $('#editLogin').val(),
                teamId: $('#editTeam').val(),
                roleId: $('#editRole').val()
            };

            $.ajax({
                type: 'POST',
                url: '/updateCoach',
                data: formData,
                success: function(response) {
                    if (response.success) {
                        var row = $('button[data-id="' + formData.id + '"]').closest('tr');
                        row.find('td').eq(2).text(formData.firstName + ' ' + formData.lastName);
                        row.find('td').eq(3).text(formData.email);
                        row.find('td').eq(1).text(formData.login);

                        $('#editCoachForm').addClass('hidden');
                    } else {
                        alert('Failed to update coach');
                    }
                }
            });
        });
    });
</script>
</body>
</html>
